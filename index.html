<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Force based label placement</title>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/accounting.js/0.4.1/accounting.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script type="text/javascript" src="red.js"></script>
</head>

<body>

  <canvas width="960" height="960"></canvas>

  <script type="text/javascript" charset="utf-8">
    var canvas = document.querySelector("canvas"),
      context = canvas.getContext("2d"),
      width = canvas.width,
      height = canvas.height,
      Distance = 150,
      transform = d3.zoomIdentity,
      types = {
        Customer: 1,
        Beneficiary: 2,
        Amount: 3
      };


    var nodes = window.Data.CustomerBeneficiary.map(m => {
      let names = m.Name.split(' ');

      m.name = names.shift();
      if (names.length > 2) {
        m.name = `${m.name} ${names.shift()}`;
      }

      m.lastName = names.join(' ');
      m.height = 30;

      m.nameWidth = context.measureText(m.name).width;
      m.lastNameWidth = context.measureText(m.lastName).width;

      m.width = m.nameWidth > m.lastNameWidth ? m.nameWidth : m.lastNameWidth;

      m.type = m.Id < 0 ? types.Customer : types.Beneficiary;
      return m;
    });

    var links = [];
    var amountLabels = [];
    var allNodes = [];

    window.Data.Movements.forEach(m => {

      let n = {
        Id: `${m.From},${m.To}`,
        label: accounting.formatMoney(m.Amount),
      }

      n.width = context.measureText(n.label);
      n.height = n.width;
      n.From = _.findWhere(nodes, {
        Id: m.From
      });
      n.To = _.findWhere(nodes, {
        Id: m.To
      });

      amountLabels.push(n);

      // links.push({
      //   source: n.Id,
      //   target: m.From,
      //   distance: Distance / 3
      // });
      //
      // links.push({
      //   source: n.Id,
      //   target: m.To,
      //   distance: Distance * 2 / 3
      // })

      links.push({
        source: m.From,
        target: m.To,
        type: types.Amount,
        distance: Distance
      });
    });

    allNodes = nodes.concat(amountLabels);

    var simulation = d3.forceSimulation(nodes)
      .force("charge", d3.forceManyBody().strength(d => d.width * -5))
      .force("link", d3.forceLink(links).distance(d => d.distance).iterations(10).id(d => d.Id))
      .force("collide", collide)
      .force("amountsLabel", amountLabelPositioning)
      .on("tick", ticked);

    d3.select("canvas")

      .call(d3.drag()
        .subject(dragsubject)
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended)
      )
      .call(d3.zoom()
        .scaleExtent([1 / 8, 2])
        .on("zoom", zoomed));

    function ticked() {
      context.save();
      context.clearRect(0, 0, width, height);

      context.translate(transform.x, transform.y);
      context.scale(transform.k, transform.k);

      context.beginPath();
      links.forEach(drawLink);
      context.strokeStyle = "#F88";
      context.stroke();

      nodes.forEach(drawNode);

      amountLabels.forEach(drawAmountLabel);

      context.restore();
    }


    function dragsubject() {
      var i,
        x = transform.invertX(d3.event.x),
        y = transform.invertY(d3.event.y),
        dx,
        dy;

      for (i = nodes.length - 1; i >= 0; --i) {
        node = nodes[i];
        dx = x - node.x;
        dy = y - node.y;
        if (dx * dx + dy * dy < 25 * 25) {
          return node;
        }
      }
    }

    function dragstarted() {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    }

    function dragged() {
      d3.event.subject.x += d3.event.dx / transform.k;
      d3.event.subject.y += d3.event.dy / transform.k;
      ticked();
    }

    function dragended() {
      if (!d3.event.active) simulation.alphaTarget(0);
    }

    function drawLink(d) {

      context.moveTo(d.source.x, d.source.y);
      context.lineTo(d.target.x, d.target.y);


    }

    function drawAmountLabel(d) {
      context.strokeStyle = "black";
      context.strokeText(d.label, d.x, d.y);
    }

    function drawNode(d) {
      context.beginPath();
      if (d.Id < 0) {
        context.fillStyle = "blue";
      } else {
        context.fillStyle = "green";
      }

      context.moveTo(d.x + 5, d.y);
      context.arc(d.x, d.y, 5, 0, 2 * Math.PI);

      context.fill();

      context.strokeStyle = "black";

      //context.strokeStyle = "white";
      //fillText strokeText
      context.strokeText(d.name, d.x - (d.nameWidth / 2), d.y + 15);
      context.strokeText(d.lastName, d.x - (d.lastNameWidth / 2), d.y + 25);

    }

    function amountLabelPositioning() {

      for (let i = 0; i < amountLabels.length; i++) {
        let a = amountLabels[i];
        a.x = (a.From.x + a.To.x) / 2;
        a.y = (a.From.y + a.To.y) / 2
      }


    }

    function collide() {
      let strength = 0.3;

      for (let i = 0; i < amountLabels.length; i++) {
        let a = amountLabels[i],
          x = a.x + a.vx - ((a.From.x + a.To.x) / 2),
          y = a.y + a.vy - ((a.From.y + a.To.y) / 2);

        a.vx = x * strength;
        a.vy = y * strength;

      }

      for (let i = 0, n = allNodes.length; i < n; ++i) {
        for (let j = i + 1; j < n; ++j) {

          let a = allNodes[i],
            b = allNodes[j],
            x = a.x + a.vx - b.x - b.vx,
            y = a.y + a.vy - b.y - b.vy,
            lx = Math.abs(x),
            ly = Math.abs(y),
            paddingX = ((a.width + b.width) / 2) + 3,
            paddingY = a.height + b.height + 3;

          if (ly < paddingY && lx < paddingX) {
            if (lx > ly) {
              lx = (lx - paddingX) * (x < 0 ? -strength : strength);
              a.vx -= lx;
              b.vx += lx;
            } else {
              ly = (ly - paddingY) * (y < 0 ? -strength : strength);
              a.vy -= ly;
              b.vy += ly;
            }
          }
        }
      }
    }

    function zoomed() {
      transform = d3.event.transform;
      ticked();
    }
  </script>
</body>

</html>